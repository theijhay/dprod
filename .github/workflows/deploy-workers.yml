name: Deploy Workers

on:
  push:
    branches:
      - main
    paths:
      - 'services/worker/**'
      - 'services/shared/**'
      - '.github/workflows/deploy-workers.yml'
  workflow_dispatch:  # Allows manual trigger

env:
  AWS_REGION: us-east-1
  ASG_NAME: dprod-worker-asg

jobs:
  deploy-workers:
    name: Deploy Worker Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create worker code package
      run: |
        echo "üì¶ Creating worker code package..."
        tar --exclude='__pycache__' \
          --exclude='*.pyc' \
          -czf worker-code.tar.gz \
          services/worker \
          services/shared
        
        echo "‚úÖ Package created: $(du -h worker-code.tar.gz | cut -f1)"

    - name: Get AWS Account ID
      id: account
      run: |
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

    - name: Upload to S3
      run: |
        BUCKET_NAME="dprod-deployments-${{ steps.account.outputs.account_id }}"
        
        # Check if bucket exists
        if ! aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
          echo "‚ö†Ô∏è  S3 bucket does not exist: $BUCKET_NAME"
          echo "   Please create it manually with: aws s3 mb s3://$BUCKET_NAME"
          exit 1
        fi
        
        echo "‚úÖ S3 bucket exists: $BUCKET_NAME"
        
        # Upload package
        aws s3 cp worker-code.tar.gz "s3://$BUCKET_NAME/worker-code.tar.gz"
        
        echo "‚úÖ Package uploaded to s3://$BUCKET_NAME/worker-code.tar.gz"

    - name: Get worker instances
      id: instances
      run: |
        INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
          --auto-scaling-group-names ${{ env.ASG_NAME }} \
          --query "AutoScalingGroups[0].Instances[?HealthStatus=='Healthy'].InstanceId" \
          --output text)
        
        if [ -z "$INSTANCE_IDS" ]; then
          echo "‚ö†Ô∏è  No healthy instances found in Auto Scaling Group"
          echo "instances=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "instances=$INSTANCE_IDS" >> $GITHUB_OUTPUT
        echo "‚úÖ Found instances: $INSTANCE_IDS"

    - name: Deploy to worker instances
      if: steps.instances.outputs.instances != ''
      run: |
        BUCKET_NAME="dprod-deployments-${{ steps.account.outputs.account_id }}"
        INSTANCE_IDS="${{ steps.instances.outputs.instances }}"
        
        for INSTANCE_ID in $INSTANCE_IDS; do
          echo "üì§ Deploying to instance: $INSTANCE_ID"
          
          # Send deployment command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              'set -e',
              'cd /opt/dprod-worker',
              'echo \"üì• Downloading worker code...\"',
              'aws s3 cp s3://$BUCKET_NAME/worker-code.tar.gz /tmp/',
              'echo \"üì¶ Extracting worker code...\"',
              'sudo tar -xzf /tmp/worker-code.tar.gz',
              'echo \"üìö Installing dependencies...\"',
              'sudo python3.11 -m pip install -r services/worker/requirements.txt --quiet',
              'echo \"üîÑ Restarting worker service...\"',
              'sudo systemctl daemon-reload',
              'sudo systemctl restart dprod-worker || true',
              'sleep 2',
              'echo \"‚úÖ Deployment complete!\"',
              'sudo systemctl status dprod-worker --no-pager'
            ]" \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)
          
          echo "   Command ID: $COMMAND_ID"
          
          # Wait for command to complete (max 2 minutes)
          echo "   Waiting for deployment to complete..."
          sleep 5
          
          for i in {1..24}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ "$STATUS" = "Success" ]; then
              echo "   ‚úÖ Deployment successful on $INSTANCE_ID"
              
              # Show output
              OUTPUT=$(aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text)
              echo "$OUTPUT" | tail -5
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "   ‚ùå Deployment failed on $INSTANCE_ID"
              
              # Show error
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardErrorContent' \
                --output text)
              echo "$ERROR"
              exit 1
            fi
            
            sleep 5
          done
        done

    - name: Verify worker health
      if: steps.instances.outputs.instances != ''
      run: |
        echo "üè• Verifying worker health..."
        
        # Check CloudWatch logs for recent activity
        RECENT_LOGS=$(aws logs filter-log-events \
          --log-group-name /dprod/worker \
          --start-time $(date -d '5 minutes ago' +%s)000 \
          --query 'events[*].message' \
          --output text 2>/dev/null || echo "")
        
        if [ -n "$RECENT_LOGS" ]; then
          echo "‚úÖ Workers are active and logging"
          echo "Recent log sample:"
          echo "$RECENT_LOGS" | head -3
        else
          echo "‚ö†Ô∏è  No recent worker logs found"
          echo "Workers may be idle or logging to a different location"
        fi

    - name: Deployment summary
      run: |
        echo "=" | head -c 60
        echo ""
        echo "‚úÖ Worker Deployment Complete!"
        echo "=" | head -c 60
        echo ""
        echo "üì¶ Package: worker-code.tar.gz"
        echo "üè∑Ô∏è  Commit: ${{ github.sha }}"
        echo "üñ•Ô∏è  Instances: ${{ steps.instances.outputs.instances || 'none' }}"
        echo ""
        echo "üìù Next Steps:"
        echo "   ‚Ä¢ Monitor logs: aws logs tail /dprod/worker --follow"
        echo "   ‚Ä¢ Test deployment: npx dprod deploy demo"
        echo "   ‚Ä¢ Check queue: aws sqs get-queue-attributes --queue-url \$SQS_QUEUE_URL"
